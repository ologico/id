---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { db, GitHub } from "astro:db";
import { eq } from "astro:db";

const humanId = await Astro.session.get("humanId");

let githubAccount = null;

if (humanId) {
  const result = await db.select().from(GitHub).where(eq(GitHub.humanId, humanId)).get();
  githubAccount = result;
}

const success = Astro.url.searchParams.get("success");
---

<Layout>
  {humanId ? (
    <div>
      <p>Logged in as: <strong>{humanId}</strong></p>
      
      {success && (
        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin: 10px 0; border-radius: 4px;">
          ✅ GitHub account linked successfully!
        </div>
      )}
      
      {githubAccount ? (
        <div>
          <h2>GitHub Account Linked</h2>
          <p>✅ Your GitHub account is already linked:</p>
          <ul>
            <li><strong>Username:</strong> {githubAccount.username}</li>
            <li><strong>GitHub ID:</strong> {githubAccount.githubId}</li>
            <li><strong>Linked:</strong> {githubAccount.linkedAt.toLocaleDateString()}</li>
          </ul>
          <button id="unlink-btn">Unlink GitHub Account</button>
        </div>
      ) : (
        <div>
          <h2>Link GitHub Account</h2>
          <p>Would you like to link your GitHub account to enable additional features?</p>
          
          <button id="link-github-btn">Link GitHub</button>
          <button id="skip-btn">Skip for now</button>
        </div>
      )}
    </div>
  ) : (
    <div>
      <script client:load>
        // Only redirect if we're actually in the "not logged in" section
        window.location.href = '/login?return=' + encodeURIComponent(window.location.pathname);
      </script>
    </div>
  )}

  <div id="result"></div>

  <script>
    document.getElementById('link-github-btn')?.addEventListener('click', () => {
      window.location.href = '/auth/github/start';
    });

    document.getElementById('skip-btn')?.addEventListener('click', () => {
      document.getElementById('result').innerHTML = '<p>GitHub linking skipped. You can link your account later.</p>';
    });

    document.getElementById('unlink-btn')?.addEventListener('click', async () => {
      if (confirm('Are you sure you want to unlink your GitHub account?')) {
        try {
          const response = await fetch('/auth/github/unlink', {
            method: 'POST',
            credentials: 'include'
          });
          
          if (response.ok) {
            window.location.reload();
          } else {
            document.getElementById('result').innerHTML = '<p style="color: red;">Failed to unlink GitHub account.</p>';
          }
        } catch (error) {
          document.getElementById('result').innerHTML = '<p style="color: red;">Error unlinking GitHub account.</p>';
        }
      }
    });
  </script>
</Layout>
